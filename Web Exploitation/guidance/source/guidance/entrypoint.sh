#!/bin/bash

FLAG_INIT="HCS{0nly_ur_h4nds_th4t_c4n_gu1d3_m3_thr0ugh_th1s_cru3l_j0urn3y_th4ts_full_0f_f4ls3_p4th5_4nd_r3r0ut3s_[UUID]}"
FLAG=${FLAG_INIT//'[UUID]'/$FLAG}

# Create a random username
USERNAME=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 8)
# Alpine uses adduser instead of useradd
adduser -D -h /home/$USERNAME -s /bin/sh $USERNAME
chown -R $USERNAME:$USERNAME /app

# Store flag in user's home directory
echo $FLAG > /flag.txt
chown $USERNAME:$USERNAME /flag.txt

unset FLAG_INIT
unset FLAG

# Remove entrypoint script for security
rm -f /entrypoint.sh

# Drop privileges and run the application
exec su-exec $USERNAME /app/guidance