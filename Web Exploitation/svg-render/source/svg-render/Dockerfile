FROM python:3.12-slim

WORKDIR /app

COPY src/requirements.txt .

RUN apt-get update && apt-get install -y \
    gcc \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
 && rm -rf /var/lib/apt/lists/* \
 && pip install --upgrade pip setuptools wheel \
 && pip install --no-cache-dir -r requirements.txt

COPY src/ .
COPY flag.txt /flag.txt

RUN USERNAME=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 8) && \
    useradd -m -s /bin/bash "$USERNAME" && \
    chown -R "$USERNAME:$USERNAME" /app && \
    mv /flag.txt /home/$USERNAME/flag.txt

EXPOSE 1337

CMD ["python", "app.py"]
